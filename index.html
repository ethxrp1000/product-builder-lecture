<!DOCTYPE html>
<html lang="ko" style="width: 1280px;"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1280, initial-scale=1, minimum-scale=0.1, user-scalable=yes">
    <title>ONZSOAP - Client Detail (ROM Measure)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;900&display=swap');
        html { -webkit-text-size-adjust: none; text-size-adjust: none; }
        body { 
            font-family: 'Pretendard', sans-serif; 
            letter-spacing: -0.02em; 
            width: 1280px; margin: 0 auto;
            background: #F8F9FA;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .tab-line { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .animate-pulse-red { animation: pulse-red 1.5s infinite; }
        
        /* ì¹´ë©”ë¼ ëª¨ë‹¬ ìµœì í™” */
        #cam-modal canvas {
            max-width: 100%;
            height: auto;
            image-rendering: optimizeSpeed;
            image-rendering: -webkit-optimize-contrast;
        }
        
        /* ì¸¡ì • ê°€ì´ë“œ ìŠ¤íƒ€ì¼ */
        .measurement-guide {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-bottom: 12px;
        }
        
        .joint-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 12px 0;
        }
        
        .joint-btn {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .joint-btn.active {
            background: #3B82F6;
            color: white;
            border-color: #3B82F6;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .status-good { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-error { background: #ef4444; }
    </style>
</head>
<body class="bg-[#F8F9FA]">

    <div id="root-container" style="width: 1280px; display: flex; min-height: 100vh;">
        <aside class="w-64 bg-white border-r border-gray-100 flex flex-col p-6 shrink-0">
            <div class="mb-10 text-[#3B82F6] font-black text-2xl tracking-tighter">ONZSOAP</div>
            <nav class="space-y-1">
                <button class="w-full text-left py-3 px-4 rounded-xl bg-[#111] text-white font-bold text-[14px]">ì£¼ê´€ì  ê¸°ë¡</button>
                <button class="w-full text-left py-3 px-4 rounded-xl text-gray-400 font-bold text-[14px] hover:bg-gray-50 transition">ê°ê´€ì  ê¸°ë¡</button>
                <button class="w-full text-left py-3 px-4 rounded-xl text-gray-400 font-bold text-[14px] hover:bg-gray-50 transition">ìƒì„¸ ê¸°ë¡</button>
                <button class="w-full text-left py-3 px-4 rounded-xl text-gray-400 font-bold text-[14px] hover:bg-gray-50 transition">ê²°ê³¼ ë³´ê³ ì„œ</button>
            </nav>
        </aside>

        <main style="width: 1024px;" class="flex flex-col shrink-0 min-w-0">
            <header class="h-14 bg-white border-b border-gray-50 flex items-center px-8 justify-between">
                <nav class="flex items-center space-x-8 text-[14px] font-bold text-gray-400">
                    <div class="flex items-center space-x-2 cursor-pointer hover:text-gray-800"><span>ğŸ  Home</span></div>
                    <div class="flex items-center space-x-2 text-[#3B82F6] cursor-pointer"><span>ğŸ‘¥ Client</span></div>
                    <div class="flex items-center space-x-2 cursor-pointer hover:text-gray-800"><span>ğŸ’¬ Community</span></div>
                </nav>
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center text-[#3B82F6] font-bold text-xs">ìœ </div>
                    <span class="text-sm font-bold text-gray-700">ìœ ì˜¤ìš´</span>
                </div>
            </header>

            <div class="h-12 flex items-center px-8 justify-between shrink-0 mt-4">
                <div class="flex items-center text-gray-500 text-[14px] font-bold cursor-pointer hover:text-gray-800">
                    <span class="mr-2 text-lg">â†</span> Client Detail
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center text-[12px] font-bold text-green-500 px-3 py-1">
                        <span class="mr-2 italic">âœ”</span> <span id="save-status">ë§ˆì§€ë§‰ ì €ì¥: ë°©ê¸ˆ ì „</span>
                    </div>
                    <button id="save-btn" class="bg-[#111] text-white text-[13px] font-bold px-5 py-2 rounded-xl hover:bg-gray-800 shadow-md transition">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
                </div>
            </div>

            <div class="p-6 flex-1 overflow-y-auto custom-scrollbar">
                <div class="bg-white rounded-[32px] shadow-sm border border-gray-100 p-10 w-[976px] mx-auto">
                    <div class="flex items-center border-b border-gray-100 mb-8 relative" id="tab-container">
                        <button class="tab-item mr-10 pb-4 text-gray-300 font-bold text-[15px] outline-none">1. ì£¼ì¦ìƒ / ë°œìƒê¸°ì „</button>
                        <button class="tab-item mr-10 pb-4 text-black font-bold text-[15px] outline-none">2. í†µì¦</button>
                        <button class="tab-item mr-10 pb-4 text-gray-300 font-bold text-[15px] outline-none">3. ê³¼ê±°ë ¥ / ì‚¬íšŒë ¥</button>
                        <button class="tab-item pb-4 text-gray-300 font-bold text-[15px] outline-none">4. ê°€ì¡±ë ¥ / í™˜ìëª©í‘œ</button>
                        <div class="tab-line absolute bottom-0 left-0 h-[2.5px] bg-[#333]"></div>
                    </div>

                    <div class="flex space-x-16">
                        <div class="flex-1 space-y-10">
                            <div class="grid grid-cols-3 gap-8">
                                <div>
                                    <label class="block text-[13px] font-bold text-gray-800 mb-3">í†µì¦ë¶€ìœ„</label>
                                    <input type="text" placeholder="í†µì¦ë¶€ìœ„ ì…ë ¥" class="w-full border-b border-gray-200 py-2 text-[14px] outline-none focus:border-blue-400 transition">
                                </div>
                                <div>
                                    <label class="block text-[13px] font-bold text-gray-800 mb-3">í†µì¦ê°•ë„</label>
                                    <div class="border border-gray-200 rounded-xl px-4 py-2.5 text-[14px] text-gray-400 flex justify-between items-center cursor-pointer">
                                        ê°•ë„ <span class="text-[8px]">â–¼</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-[13px] font-bold text-gray-800 mb-3">1ì¼ í†µì¦ ì§€ì†ë¥ (%)</label>
                                    <div class="border border-gray-200 rounded-xl px-4 py-2.5 text-[14px] text-gray-400 flex justify-between items-center cursor-pointer">
                                        ì§€ì†ë¥  <span class="text-[8px]">â–¼</span>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <div class="flex justify-between items-center mb-3">
                                    <label class="text-[13px] font-bold text-gray-800">ê¸°íƒ€ ì„ìƒ ì†Œê²¬</label>
                                    <div class="flex items-center space-x-3">
                                        <span id="stt-status" class="text-[10px] font-bold text-red-500 hidden animate-pulse-red">â— REC</span>
                                        <button id="mic-btn" class="text-gray-400 cursor-pointer hover:text-[#3B82F6] transition-colors p-1" title="ìŒì„± ì¸ì‹ ì‹œì‘">
                                            <span class="text-lg">ğŸ™ï¸</span>
                                        </button>
                                        <button id="cam-btn" class="text-gray-400 cursor-pointer hover:text-green-500 transition-colors p-1" title="ì¹´ë©”ë¼ ì¸¡ì • ì‹œì‘">
                                            <span class="text-lg">ğŸ“·</span>
                                        </button>
                                    </div>
                                </div>
                                <textarea id="memo-textarea" placeholder="ì¸¡ì • ê²°ê³¼ ë° ì„ìƒ ì†Œê²¬ì´ ì—¬ê¸°ì— ì…ë ¥ë©ë‹ˆë‹¤." class="w-full h-32 bg-gray-50/50 border border-gray-100 rounded-2xl p-5 text-[14px] outline-none focus:border-blue-200 transition resize-none"></textarea>
                            </div>
                        </div>

                        <div class="w-[340px] shrink-0">
                            <div id="body-chart-container" class="w-full h-[480px] border border-gray-100 rounded-2xl bg-[#FCFDFF] relative flex items-center justify-center overflow-hidden shadow-inner cursor-crosshair">
                                <div class="text-center z-10 pointer-events-none select-none">
                                    <div class="text-gray-200 text-6xl mb-4">ğŸ‘¤</div>
                                    <p class="text-gray-300 font-bold text-sm tracking-widest uppercase">Body Chart</p>
                                </div>
                            </div>
                        </div>
                    </div> 
                </div>
            </div>
        </main>
    </div>

    <!-- ì¹´ë©”ë¼ ì¸¡ì • ëª¨ë‹¬ (ê°œì„ ë¨) -->
    <div id="cam-modal" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center p-10">
        <div class="bg-white rounded-[32px] w-full max-w-4xl overflow-hidden relative shadow-2xl">
            <div class="p-6 border-b flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-lg">ì‹¤ì‹œê°„ ê°€ë™ë²”ìœ„(ROM) ì¸¡ì •</h3>
                    <div class="flex items-center mt-2 text-xs">
                        <span class="status-indicator" id="detection-status"></span>
                        <span id="detection-text" class="text-gray-500">ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘...</span>
                    </div>
                </div>
                <button id="close-cam" class="text-gray-400 hover:text-black text-2xl">Ã—</button>
            </div>
            
            <!-- ì¸¡ì • ê°€ì´ë“œ -->
            <div class="measurement-guide mx-6 mt-4">
                <div class="font-bold mb-1">ğŸ“‹ ì¸¡ì • ê°€ì´ë“œ</div>
                <div id="guide-text" class="text-xs opacity-90">
                    ì¸¡ì •í•  ê´€ì ˆì„ ì„ íƒí•˜ê³ , ì¹´ë©”ë¼ ì•ì—ì„œ ì²œì²œíˆ ì›€ì§ì—¬ì£¼ì„¸ìš”.
                </div>
            </div>
            
            <!-- ê´€ì ˆ ì„ íƒ -->
            <div class="px-6">
                <label class="block text-sm font-bold mb-2">ì¸¡ì • ê´€ì ˆ ì„ íƒ</label>
                <div class="joint-selector">
                    <button class="joint-btn active" data-joint="elbow-right">ìš°ì¸¡ íŒ”ê¿ˆì¹˜</button>
                    <button class="joint-btn" data-joint="elbow-left">ì¢Œì¸¡ íŒ”ê¿ˆì¹˜</button>
                    <button class="joint-btn" data-joint="shoulder-right">ìš°ì¸¡ ì–´ê¹¨</button>
                    <button class="joint-btn" data-joint="shoulder-left">ì¢Œì¸¡ ì–´ê¹¨</button>
                    <button class="joint-btn" data-joint="knee-right">ìš°ì¸¡ ë¬´ë¦</button>
                    <button class="joint-btn" data-joint="knee-left">ì¢Œì¸¡ ë¬´ë¦</button>
                    <button class="joint-btn" data-joint="hip-right">ìš°ì¸¡ ê³ ê´€ì ˆ</button>
                    <button class="joint-btn" data-joint="hip-left">ì¢Œì¸¡ ê³ ê´€ì ˆ</button>
                </div>
            </div>
            
            <div class="relative bg-black flex justify-center">
                <video id="input_video" class="hidden"></video>
                <canvas id="output_canvas" width="640" height="480" class="w-full h-auto"></canvas>
                
                <!-- ì¸¡ì • ë°ì´í„° í‘œì‹œ (ê°œì„ ë¨) -->
                <div class="absolute top-5 right-5 bg-black/70 text-white p-4 rounded-2xl backdrop-blur-md min-w-[160px]">
                    <p class="text-[10px] text-gray-300 uppercase font-bold mb-1">í˜„ì¬ ê°ë„</p>
                    <p class="text-4xl font-black text-green-400" id="current-angle">--Â°</p>
                    
                    <div class="border-t border-gray-600 my-3"></div>
                    
                    <p class="text-[10px] text-gray-300 uppercase font-bold mb-1">ìµœëŒ€ ê°ë„</p>
                    <p class="text-2xl font-black text-blue-400" id="max-angle">--Â°</p>
                    
                    <div class="border-t border-gray-600 my-3"></div>
                    
                    <p class="text-[10px] text-gray-300 uppercase font-bold mb-1">ì¸¡ì • ì‹œê°„</p>
                    <p class="text-sm font-bold text-yellow-400" id="measure-time">00:00</p>
                </div>
                
                <!-- FPS í‘œì‹œ (ë””ë²„ê¹…ìš©) -->
                <div class="absolute top-5 left-5 bg-black/50 text-white px-3 py-2 rounded-lg text-xs font-mono">
                    FPS: <span id="fps-display">0</span>
                </div>
            </div>
            
            <div class="p-6 bg-gray-50 flex justify-between items-center">
                <div class="text-xs text-gray-600">
                    <span class="font-bold">ğŸ’¡ Tip:</span> ì¸¡ì • ì¤‘ ì›€ì§ì„ì„ ì²œì²œíˆ í•˜ë©´ ë” ì •í™•í•©ë‹ˆë‹¤
                </div>
                <div class="flex space-x-3">
                    <button id="reset-max" class="px-6 py-2 bg-white border rounded-xl font-bold text-sm hover:bg-gray-100 transition">ì´ˆê¸°í™”</button>
                    <button id="apply-rom" class="px-6 py-2 bg-[#111] text-white rounded-xl font-bold text-sm hover:bg-gray-800 transition shadow-lg">ê²°ê³¼ ë°˜ì˜</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // 1. ê¸°ë³¸ UI ë¡œì§
        // ========================================
        const tabs = document.querySelectorAll('.tab-item');
        const tabLine = document.querySelector('.tab-line');
        
        function moveLine(element) {
            const rect = element.getBoundingClientRect();
            const containerRect = document.getElementById('tab-container').getBoundingClientRect();
            tabLine.style.width = `${rect.width}px`;
            tabLine.style.left = `${rect.left - containerRect.left}px`;
        }
        
        tabs.forEach((tab) => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => { 
                    t.classList.remove('text-black'); 
                    t.classList.add('text-gray-300'); 
                });
                tab.classList.add('text-black'); 
                tab.classList.remove('text-gray-300');
                moveLine(tab);
            });
        });
        
        window.onload = () => { moveLine(tabs[1]); };

        // ========================================
        // 2. ROM ì¸¡ì • ì‹œìŠ¤í…œ (ìµœì í™” ë° ê°œì„ )
        // ========================================
        
        // DOM ìš”ì†Œ
        const camBtn = document.getElementById('cam-btn');
        const camModal = document.getElementById('cam-modal');
        const closeCam = document.getElementById('close-cam');
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const angleDisplay = document.getElementById('current-angle');
        const maxAngleDisplay = document.getElementById('max-angle');
        const memoTextarea = document.getElementById('memo-textarea');
        const detectionStatus = document.getElementById('detection-status');
        const detectionText = document.getElementById('detection-text');
        const guideText = document.getElementById('guide-text');
        const measureTimeDisplay = document.getElementById('measure-time');
        const fpsDisplay = document.getElementById('fps-display');
        
        // ì¸¡ì • ìƒíƒœ ë³€ìˆ˜
        let maxROM = 0;
        let currentJoint = 'elbow-right';
        let measureStartTime = null;
        let isDetecting = false;
        let camera = null;
        let pose = null;
        
        // FPS ê³„ì‚°
        let lastFrameTime = Date.now();
        let frameCount = 0;
        let fps = 0;
        
        // ê´€ì ˆë³„ ì¸¡ì • ì„¤ì •
        const jointConfigs = {
            'elbow-right': {
                name: 'ìš°ì¸¡ íŒ”ê¿ˆì¹˜',
                landmarks: [11, 13, 15], // ì–´ê¹¨-íŒ”ê¿ˆì¹˜-ì†ëª©
                guide: 'íŒ”ì„ í´ê³  êµ¬ë¶€ë¦¬ëŠ” ë™ì‘ì„ ì²œì²œíˆ ë°˜ë³µí•´ì£¼ì„¸ìš”. íŒ”ê¿ˆì¹˜ê°€ í™”ë©´ì— ì˜ ë³´ì´ë„ë¡ í•´ì£¼ì„¸ìš”.',
                minAngle: 30,
                normalRange: [0, 150]
            },
            'elbow-left': {
                name: 'ì¢Œì¸¡ íŒ”ê¿ˆì¹˜',
                landmarks: [12, 14, 16],
                guide: 'íŒ”ì„ í´ê³  êµ¬ë¶€ë¦¬ëŠ” ë™ì‘ì„ ì²œì²œíˆ ë°˜ë³µí•´ì£¼ì„¸ìš”. íŒ”ê¿ˆì¹˜ê°€ í™”ë©´ì— ì˜ ë³´ì´ë„ë¡ í•´ì£¼ì„¸ìš”.',
                minAngle: 30,
                normalRange: [0, 150]
            },
            'shoulder-right': {
                name: 'ìš°ì¸¡ ì–´ê¹¨',
                landmarks: [11, 13, 23], // ì–´ê¹¨-íŒ”ê¿ˆì¹˜-ì—‰ë©ì´
                guide: 'íŒ”ì„ ì˜†ìœ¼ë¡œ ì²œì²œíˆ ë“¤ì–´ì˜¬ë ¸ë‹¤ ë‚´ë¦¬ëŠ” ë™ì‘ì„ ë°˜ë³µí•´ì£¼ì„¸ìš”.',
                minAngle: 20,
                normalRange: [0, 180]
            },
            'shoulder-left': {
                name: 'ì¢Œì¸¡ ì–´ê¹¨',
                landmarks: [12, 14, 24],
                guide: 'íŒ”ì„ ì˜†ìœ¼ë¡œ ì²œì²œíˆ ë“¤ì–´ì˜¬ë ¸ë‹¤ ë‚´ë¦¬ëŠ” ë™ì‘ì„ ë°˜ë³µí•´ì£¼ì„¸ìš”.',
                minAngle: 20,
                normalRange: [0, 180]
            },
            'knee-right': {
                name: 'ìš°ì¸¡ ë¬´ë¦',
                landmarks: [23, 25, 27], // ì—‰ë©ì´-ë¬´ë¦-ë°œëª©
                guide: 'ë‹¤ë¦¬ë¥¼ ì²œì²œíˆ êµ¬ë¶€ë ¸ë‹¤ í´ëŠ” ë™ì‘ì„ ë°˜ë³µí•´ì£¼ì„¸ìš”. ì˜†ëª¨ìŠµì´ ì˜ ë³´ì´ë„ë¡ ì„œì£¼ì„¸ìš”.',
                minAngle: 30,
                normalRange: [0, 140]
            },
            'knee-left': {
                name: 'ì¢Œì¸¡ ë¬´ë¦',
                landmarks: [24, 26, 28],
                guide: 'ë‹¤ë¦¬ë¥¼ ì²œì²œíˆ êµ¬ë¶€ë ¸ë‹¤ í´ëŠ” ë™ì‘ì„ ë°˜ë³µí•´ì£¼ì„¸ìš”. ì˜†ëª¨ìŠµì´ ì˜ ë³´ì´ë„ë¡ ì„œì£¼ì„¸ìš”.',
                minAngle: 30,
                normalRange: [0, 140]
            },
            'hip-right': {
                name: 'ìš°ì¸¡ ê³ ê´€ì ˆ',
                landmarks: [11, 23, 25], // ì–´ê¹¨-ì—‰ë©ì´-ë¬´ë¦
                guide: 'ë‹¤ë¦¬ë¥¼ ì•ìœ¼ë¡œ ì²œì²œíˆ ë“¤ì–´ì˜¬ë ¸ë‹¤ ë‚´ë¦¬ëŠ” ë™ì‘ì„ ë°˜ë³µí•´ì£¼ì„¸ìš”.',
                minAngle: 20,
                normalRange: [0, 120]
            },
            'hip-left': {
                name: 'ì¢Œì¸¡ ê³ ê´€ì ˆ',
                landmarks: [12, 24, 26],
                guide: 'ë‹¤ë¦¬ë¥¼ ì•ìœ¼ë¡œ ì²œì²œíˆ ë“¤ì–´ì˜¬ë ¸ë‹¤ ë‚´ë¦¬ëŠ” ë™ì‘ì„ ë°˜ë³µí•´ì£¼ì„¸ìš”.',
                minAngle: 20,
                normalRange: [0, 120]
            }
        };
        
        // ê°ë„ ê³„ì‚° í•¨ìˆ˜ (ê°œì„ ë¨)
        function calculateAngle(a, b, c) {
            if (!a || !b || !c) return 0;
            
            const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs((radians * 180.0) / Math.PI);
            
            if (angle > 180.0) {
                angle = 360 - angle;
            }
            
            return angle;
        }
        
        // ëœë“œë§ˆí¬ ì‹ ë¢°ë„ ê²€ì¦
        function isValidLandmark(landmark, minVisibility = 0.6) {
            return landmark && landmark.visibility > minVisibility;
        }
        
        // ì¸¡ì • ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateDetectionStatus(status, message) {
            detectionStatus.className = 'status-indicator';
            
            switch(status) {
                case 'good':
                    detectionStatus.classList.add('status-good');
                    isDetecting = true;
                    break;
                case 'warning':
                    detectionStatus.classList.add('status-warning');
                    isDetecting = true;
                    break;
                case 'error':
                    detectionStatus.classList.add('status-error');
                    isDetecting = false;
                    break;
            }
            
            detectionText.textContent = message;
        }
        
        // ì¸¡ì • ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateMeasureTime() {
            if (!measureStartTime) return;
            
            const elapsed = Math.floor((Date.now() - measureStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            measureTimeDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        // MediaPipe Pose ì´ˆê¸°í™” (ìµœì í™”ë¨)
        function initializePose() {
            pose = new Pose({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
            });

            // ëª¨ë°”ì¼ ìµœì í™” ì„¤ì •
            pose.setOptions({
                modelComplexity: 1,              // 0=Lite, 1=Full, 2=Heavy (1ë¡œ ê· í˜•)
                smoothLandmarks: true,            // ë¶€ë“œëŸ¬ìš´ ì¶”ì 
                enableSegmentation: false,        // ì„¸ê·¸ë©˜í…Œì´ì…˜ ë¹„í™œì„±í™” (ì„±ëŠ¥ í–¥ìƒ)
                smoothSegmentation: false,
                minDetectionConfidence: 0.6,      // ê²€ì¶œ ì‹ ë¢°ë„ (ë†’ì¼ìˆ˜ë¡ ì •í™•í•˜ì§€ë§Œ ëŠë¦¼)
                minTrackingConfidence: 0.5        // ì¶”ì  ì‹ ë¢°ë„
            });

            pose.onResults(onPoseResults);
        }
        
        // Pose ê²°ê³¼ ì²˜ë¦¬ (ê°œì„ ë¨)
        function onPoseResults(results) {
            // FPS ê³„ì‚°
            frameCount++;
            const now = Date.now();
            if (now - lastFrameTime >= 1000) {
                fps = frameCount;
                fpsDisplay.textContent = fps;
                frameCount = 0;
                lastFrameTime = now;
            }
            
            // ìº”ë²„ìŠ¤ í´ë¦¬ì–´ ë° ë¹„ë””ì˜¤ ê·¸ë¦¬ê¸°
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            
            // ëœë“œë§ˆí¬ê°€ ì—†ìœ¼ë©´ ê²½ê³ 
            if (!results.poseLandmarks) {
                updateDetectionStatus('error', 'ì‚¬ëŒì„ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì „ì‹ ì´ ë³´ì´ë„ë¡ ì¡°ì •í•´ì£¼ì„¸ìš”.');
                angleDisplay.innerText = '--Â°';
                canvasCtx.restore();
                return;
            }
            
            // ì „ì²´ ìŠ¤ì¼ˆë ˆí†¤ ê·¸ë¦¬ê¸° (ì—°í•œ ìƒ‰ìƒ)
            drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {
                color: '#E5E7EB', 
                lineWidth: 2
            });
            drawLandmarks(canvasCtx, results.poseLandmarks, {
                color: '#9CA3AF', 
                lineWidth: 1, 
                radius: 3,
                fillColor: '#F3F4F6'
            });
            
            // ì„ íƒëœ ê´€ì ˆ ì¸¡ì •
            const config = jointConfigs[currentJoint];
            const [idx1, idx2, idx3] = config.landmarks;
            
            const point1 = results.poseLandmarks[idx1];
            const point2 = results.poseLandmarks[idx2];
            const point3 = results.poseLandmarks[idx3];
            
            // ëœë“œë§ˆí¬ ì‹ ë¢°ë„ ê²€ì¦
            if (!isValidLandmark(point1) || !isValidLandmark(point2) || !isValidLandmark(point3)) {
                updateDetectionStatus('warning', 'ê´€ì ˆì´ ëª…í™•í•˜ê²Œ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. ìì„¸ë¥¼ ì¡°ì •í•´ì£¼ì„¸ìš”.');
                angleDisplay.innerText = '--Â°';
                canvasCtx.restore();
                return;
            }
            
            // ì¸¡ì • ê´€ì ˆ ê°•ì¡° í‘œì‹œ
            const highlightPoints = [point1, point2, point3];
            
            // ì—°ê²°ì„  ê°•ì¡°
            canvasCtx.beginPath();
            canvasCtx.moveTo(point1.x * canvasElement.width, point1.y * canvasElement.height);
            canvasCtx.lineTo(point2.x * canvasElement.width, point2.y * canvasElement.height);
            canvasCtx.lineTo(point3.x * canvasElement.width, point3.y * canvasElement.height);
            canvasCtx.strokeStyle = '#3B82F6';
            canvasCtx.lineWidth = 4;
            canvasCtx.stroke();
            
            // í¬ì¸íŠ¸ ê°•ì¡°
            highlightPoints.forEach((point, index) => {
                const x = point.x * canvasElement.width;
                const y = point.y * canvasElement.height;
                
                canvasCtx.beginPath();
                canvasCtx.arc(x, y, 8, 0, 2 * Math.PI);
                canvasCtx.fillStyle = index === 1 ? '#EF4444' : '#3B82F6'; // ì¤‘ê°„ ê´€ì ˆì€ ë¹¨ê°„ìƒ‰
                canvasCtx.fill();
                canvasCtx.strokeStyle = 'white';
                canvasCtx.lineWidth = 2;
                canvasCtx.stroke();
            });
            
            // ê°ë„ ê³„ì‚°
            const angle = calculateAngle(point1, point2, point3);
            const displayAngle = Math.round(angle);
            
            // ìœ íš¨í•œ ê°ë„ì¸ì§€ í™•ì¸
            if (displayAngle < config.minAngle) {
                updateDetectionStatus('warning', 'ì¸¡ì • ë²”ìœ„ê°€ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤. ë” í¬ê²Œ ì›€ì§ì—¬ì£¼ì„¸ìš”.');
            } else {
                updateDetectionStatus('good', 'ì¸¡ì • ì¤‘... ì •ìƒ ì‘ë™');
            }
            
            // ê°ë„ í‘œì‹œ
            angleDisplay.innerText = `${displayAngle}Â°`;
            
            // ìµœëŒ€ê°’ ì—…ë°ì´íŠ¸
            if (displayAngle >= config.minAngle && displayAngle > maxROM) {
                maxROM = displayAngle;
                maxAngleDisplay.innerText = `${maxROM}Â°`;
                
                // ìµœëŒ€ê°’ ê°±ì‹  ì‹œ ì‹œê°ì  í”¼ë“œë°±
                maxAngleDisplay.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    maxAngleDisplay.style.transform = 'scale(1)';
                }, 200);
            }
            
            // ê°ë„ í…ìŠ¤íŠ¸ë¥¼ ê´€ì ˆ ì˜†ì— í‘œì‹œ
            const jointX = point2.x * canvasElement.width;
            const jointY = point2.y * canvasElement.height;
            
            canvasCtx.font = 'bold 24px Pretendard';
            canvasCtx.fillStyle = '#FFFFFF';
            canvasCtx.strokeStyle = '#000000';
            canvasCtx.lineWidth = 4;
            canvasCtx.strokeText(`${displayAngle}Â°`, jointX + 15, jointY - 15);
            canvasCtx.fillText(`${displayAngle}Â°`, jointX + 15, jointY - 15);
            
            canvasCtx.restore();
            
            // ì¸¡ì • ì‹œê°„ ì—…ë°ì´íŠ¸
            updateMeasureTime();
        }
        
        // ì¹´ë©”ë¼ ì´ˆê¸°í™” (ê°œì„ ë¨)
        function initializeCamera() {
            // ê¸°ì¡´ ì¹´ë©”ë¼ê°€ ìˆìœ¼ë©´ ì •ë¦¬
            if (camera) {
                camera.stop();
            }
            
            camera = new Camera(videoElement, {
                onFrame: async () => {
                    if (pose) {
                        await pose.send({image: videoElement});
                    }
                },
                width: 640,   // í•´ìƒë„ ìµœì í™” (ë„ˆë¬´ ë†’ìœ¼ë©´ ëŠë ¤ì§)
                height: 480,
                facingMode: 'environment' // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
            });
        }
        
        // ê´€ì ˆ ì„ íƒ ë²„íŠ¼
        const jointBtns = document.querySelectorAll('.joint-btn');
        jointBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                jointBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentJoint = btn.dataset.joint;
                
                // ìµœëŒ€ê°’ ì´ˆê¸°í™”
                maxROM = 0;
                maxAngleDisplay.innerText = '--Â°';
                
                // ê°€ì´ë“œ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                guideText.textContent = jointConfigs[currentJoint].guide;
            });
        });
        
        // ì¹´ë©”ë¼ ì‹œì‘
        camBtn.addEventListener('click', async () => {
            camModal.classList.remove('hidden');
            
            // ì´ˆê¸°í™”
            maxROM = 0;
            maxAngleDisplay.innerText = '--Â°';
            angleDisplay.innerText = '--Â°';
            measureStartTime = Date.now();
            
            // ê°€ì´ë“œ í…ìŠ¤íŠ¸ ì„¤ì •
            guideText.textContent = jointConfigs[currentJoint].guide;
            
            // Pose ì´ˆê¸°í™” (ì²˜ìŒ í•œ ë²ˆë§Œ)
            if (!pose) {
                initializePose();
            }
            
            // ì¹´ë©”ë¼ ì´ˆê¸°í™” ë° ì‹œì‘
            initializeCamera();
            
            try {
                updateDetectionStatus('warning', 'ì¹´ë©”ë¼ ì‹œì‘ ì¤‘...');
                await camera.start();
                updateDetectionStatus('good', 'ì¸¡ì • ì¤€ë¹„ ì™„ë£Œ');
                
                // ì¸¡ì • ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘
                const timeInterval = setInterval(() => {
                    if (camModal.classList.contains('hidden')) {
                        clearInterval(timeInterval);
                    } else {
                        updateMeasureTime();
                    }
                }, 1000);
                
            } catch (err) {
                console.error('Camera error:', err);
                updateDetectionStatus('error', 'ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                alert('ì¹´ë©”ë¼ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n1. HTTPS í™˜ê²½ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸\n2. ì¹´ë©”ë¼ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸\n3. ë‹¤ë¥¸ ì•±ì—ì„œ ì¹´ë©”ë¼ë¥¼ ì‚¬ìš© ì¤‘ì´ì§€ ì•ŠëŠ”ì§€ í™•ì¸');
            }
        });
        
        // ì¹´ë©”ë¼ ì¢…ë£Œ
        closeCam.addEventListener('click', () => {
            camModal.classList.add('hidden');
            if (camera) {
                camera.stop();
            }
            measureStartTime = null;
        });
        
        // ì´ˆê¸°í™” ë²„íŠ¼
        document.getElementById('reset-max').addEventListener('click', () => {
            maxROM = 0;
            maxAngleDisplay.innerText = '--Â°';
            measureStartTime = Date.now();
        });
        
        // ê²°ê³¼ ë°˜ì˜ ë²„íŠ¼ (ê°œì„ ë¨)
        document.getElementById('apply-rom').addEventListener('click', () => {
            const config = jointConfigs[currentJoint];
            const timestamp = new Date().toLocaleString('ko-KR', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // ì¸¡ì • ì‹œê°„ ê³„ì‚°
            const measureDuration = Math.floor((Date.now() - measureStartTime) / 1000);
            const minutes = Math.floor(measureDuration / 60);
            const seconds = measureDuration % 60;
            const durationText = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;
            
            // ì •ìƒ ë²”ìœ„ì™€ ë¹„êµ
            const [minNormal, maxNormal] = config.normalRange;
            let interpretation = '';
            
            if (maxROM < minNormal + 20) {
                interpretation = ' (ì œí•œì )';
            } else if (maxROM >= maxNormal - 10) {
                interpretation = ' (ì •ìƒ)';
            } else {
                interpretation = ' (ì–‘í˜¸)';
            }
            
            // ê¸°ë¡ ì¶”ê°€
            const record = `[ROM ì¸¡ì • - ${timestamp}]\në¶€ìœ„: ${config.name}\nìµœëŒ€ ê°€ë™ë²”ìœ„: ${maxROM}Â°${interpretation}\nì¸¡ì • ì‹œê°„: ${durationText}\nì •ìƒ ë²”ìœ„: ${minNormal}-${maxNormal}Â°\n`;
            
            memoTextarea.value += (memoTextarea.value ? '\n' : '') + record;
            
            // ëª¨ë‹¬ ë‹«ê¸°
            camModal.classList.add('hidden');
            if (camera) {
                camera.stop();
            }
            
            // ì„±ê³µ í”¼ë“œë°±
            alert(`${config.name} ì¸¡ì • ê²°ê³¼ê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\nìµœëŒ€ ROM: ${maxROM}Â°`);
        });

        // ========================================
        // 3. ìŒì„± ì¸ì‹ (STT)
        // ========================================
        const micBtn = document.getElementById('mic-btn');
        const sttStatus = document.getElementById('stt-status');
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.lang = 'ko-KR';
            recognition.interimResults = false;
            
            let isRecording = false;
            
            micBtn.addEventListener('click', () => {
                if (isRecording) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            });
            
            recognition.onstart = () => {
                isRecording = true;
                sttStatus.classList.remove('hidden');
                micBtn.classList.add('text-red-500');
            };
            
            recognition.onend = () => {
                isRecording = false;
                sttStatus.classList.add('hidden');
                micBtn.classList.remove('text-red-500');
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript;
                memoTextarea.value += (memoTextarea.value ? ' ' : '') + transcript;
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isRecording = false;
                sttStatus.classList.add('hidden');
                micBtn.classList.remove('text-red-500');
            };
        } else {
            micBtn.style.display = 'none';
            console.warn('ìŒì„± ì¸ì‹ì´ ì´ ë¸Œë¼ìš°ì €ì—ì„œ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }

        // ========================================
        // 4. ì €ì¥ ê¸°ëŠ¥
        // ========================================
        document.getElementById('save-btn').addEventListener('click', () => {
            const saveStatus = document.getElementById('save-status');
            saveStatus.textContent = 'ì €ì¥ ì¤‘...';
            
            // ì‹¤ì œë¡œëŠ” ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡
            setTimeout(() => {
                saveStatus.textContent = 'ë§ˆì§€ë§‰ ì €ì¥: ë°©ê¸ˆ ì „';
                alert('ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }, 500);
        });
        
        // ========================================
        // 5. í˜ì´ì§€ ì´íƒˆ ë°©ì§€
        // ========================================
        window.addEventListener('beforeunload', (e) => {
            if (memoTextarea.value.trim() !== '') {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>