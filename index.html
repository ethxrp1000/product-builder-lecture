<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PVYKGJS6WM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-PVYKGJS6WM');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>숨, 쉼 - 명상 챌린지</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500&display=swap');

        :root {
            --bg-color: #F0F2F0;
            --primary-color: #5D6D7E;
            --secondary-color: #A3B18A;
            --text-color: #34495E;
            --highlight-color: #588157;
        }

        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            background-size: cover;
            background-position: center;
            transition: background-image 1s ease-in-out;
        }

        .app-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }

        .container {
            text-align: center;
            background-color: rgba(255, 255, 255, 0.85);
            padding: 40px 50px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            max-width: 400px;
            width: 90%;
            transition: all 0.5s ease;
        }

        h1 {
            font-weight: 500;
            font-size: 28px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        p {
            font-size: 16px;
            margin-bottom: 30px;
            color: var(--text-color);
        }

        .challenge-buttons button {
            background-color: transparent;
            border: 2px solid var(--secondary-color);
            color: var(--text-color);
            padding: 12px 24px;
            margin: 0 8px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 400;
            transition: all 0.3s ease;
        }

        .challenge-buttons button:hover, .challenge-buttons button.active {
            background-color: var(--secondary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .timer-container {
            margin-top: 30px;
            display: none;
        }

        #timer {
            font-size: 64px;
            font-weight: 300;
            color: var(--highlight-color);
            margin-bottom: 20px;
        }

        #message {
            font-size: 18px;
            font-weight: 500;
            color: var(--primary-color);
            min-height: 27px;
        }

        #reset-button {
            display: none;
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            margin-top: 20px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        #reset-button:hover {
            background-color: #4A5A6A;
        }

        #progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 20px;
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--highlight-color);
            border-radius: 5px;
            transition: width 1s linear;
        }

        #fullscreen-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--primary-color);
        }

    </style>
</head>
<body>

    <div class="app-container">
        <div class="container">
            <button id="fullscreen-button">⛶</button>
            <h1>명상 챌린지</h1>
            <p>잠시 모든 것을 잊고, 온전히 숨에 집중하는 시간</p>
            <div class="challenge-buttons">
                <button data-duration="60">1분</button>
                <button data-duration="120">2분</button>
                <button data-duration="180">3분</button>
                <button data-duration="300">5분</button>
            </div>
            <div class="timer-container">
                <div id="timer">00:00</div>
                <div id="progress-bar-container">
                    <div id="progress-bar"></div>
                </div>
                <p id="message"></p>
                <button id="reset-button">다시하기</button>
            </div>
        </div>
    </div>

    <audio id="nature-sound" loop src="https://cdn.pixabay.com/audio/2022/10/18/audio_83a15dc289.mp3"></audio>

    <script>
        const challengeButtons = document.querySelector('.challenge-buttons');
        const timerContainer = document.querySelector('.timer-container');
        const timerDisplay = document.getElementById('timer');
        const messageDisplay = document.getElementById('message');
        const resetButton = document.getElementById('reset-button');
        const natureSound = document.getElementById('nature-sound');
        const initialUI = document.querySelector('.container p');
        const h1 = document.querySelector('h1');
        const progressBar = document.getElementById('progress-bar');
        const fullscreenButton = document.getElementById('fullscreen-button');

        const natureSounds = [
            "https://assets.mixkit.co/sfx/preview/mixkit-forest-at-night-1233.mp3",
            "https://assets.mixkit.co/sfx/preview/mixkit-summer-night-crickets-and-wind-1229.mp3",
            "https://assets.mixkit.co/sfx/preview/mixkit-jungle-atmosphere-with-insects-and-birds-2413.mp3",
            "https://assets.mixkit.co/sfx/preview/mixkit-light-rain-and-crickets-1240.mp3",
            "https://assets.mixkit.co/sfx/preview/mixkit-rain-and-thunder-in-the-forest-1254.mp3",
            "https://assets.mixkit.co/sfx/preview/mixkit-calm-river-in-the-jungle-1252.mp3",
            "https://assets.mixkit.co/sfx/preview/mixkit-waterfall-in-a-cave-1223.mp3",
            "https://assets.mixkit.co/sfx/preview/mixkit-waves-coming-to-the-shore-1260.mp3",
            "https://assets.mixkit.co/sfx/preview/mixkit-gentle-ocean-waves-1129.mp3",
            "https://assets.mixkit.co/sfx/preview/mixkit-campfire-crackles-1330.mp3",
            "https://assets.mixkit.co/sfx/preview/mixkit-wind-in-the-trees-1174.mp3",
            "https://assets.mixkit.co/sfx/preview/mixkit-strong-wind-whistle-1205.mp3",
            "https://assets.mixkit.co/sfx/preview/mixkit-birds-singing-in-the-forest-1234.mp3",
            "https://assets.mixkit.co/sfx/preview/mixkit-singing-birds-in-the-morning-1232.mp3",
            "https://assets.mixkit.co/sfx/preview/mixkit-owl-hooting-in-the-forest-2480.mp3",
            "https://assets.mixkit.co/sfx/preview/mixkit-wolf-howling-in-the-night-1219.mp3",
            "https://assets.mixkit.co/sfx/preview/mixkit-crickets-chirping-in-the-night-1243.mp3",
            "https://assets.mixkit.co/sfx/preview/mixkit-cicadas-in-a-field-2407.mp3",
            "https://assets.mixkit.co/sfx/preview/mixkit-frogs-croaking-in-a-pond-1231.mp3",
            "https://assets.mixkit.co/sfx/preview/mixkit-bees-buzzing-in-a-meadow-2482.mp3"
        ];

        const backgroundImages = [
            "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=2071&auto=format&fit=crop", // Sunday
            "https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?q=80&w=1948&auto=format&fit=crop", // Monday
            "https://images.unsplash.com/photo-1447752875215-b2761acb3c5d?q=80&w=2070&auto=format&fit=crop", // Tuesday
            "https://images.unsplash.com/photo-1426604966848-d7adac402bff?q=80&w=2070&auto=format&fit=crop", // Wednesday
            "https://images.unsplash.com/photo-1501854140801-50d01698950b?q=80&w=2175&auto=format&fit=crop", // Thursday
            "https://images.unsplash.com/photo-1433086966358-54859d0ed716?q=80&w=1974&auto=format&fit=crop", // Friday
            "https://images.unsplash.com/photo-1475924156734-496f6cac6ec1?q=80&w=2070&auto=format&fit=crop"  // Saturday
        ];

        let timer;
        let totalSeconds = 0;
        let initialDuration = 0;
        let audioContextUnlocked = false;

        document.addEventListener('DOMContentLoaded', () => {
            const dayOfWeek = new Date().getDay();
            document.body.style.backgroundImage = `url('${backgroundImages[dayOfWeek]}')`;
        });

        // Unlock audio context on first user interaction
        function unlockAudioContext() {
            if (audioContextUnlocked) return;

            const audio = new Audio(); // Create a dummy audio element
            audio.volume = 0; // Mute it
            audio.play()
                .then(() => {
                    audio.pause(); // Immediately pause it
                    audioContextUnlocked = true;
                    console.log('Audio context unlocked.');
                })
                .catch(error => {
                    console.error('Failed to unlock audio context:', error);
                });
            document.removeEventListener('click', unlockAudioContext);
            document.removeEventListener('touchstart', unlockAudioContext);
        }

        document.addEventListener('click', unlockAudioContext);
        document.addEventListener('touchstart', unlockAudioContext);

        challengeButtons.addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') {
                const duration = parseInt(e.target.dataset.duration, 10);
                startChallenge(duration, e.target);
            }
        });

        resetButton.addEventListener('click', () => {
            resetChallenge();
        });

        fullscreenButton.addEventListener('click', () => {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                document.documentElement.requestFullscreen();
            }
        });

        function startChallenge(duration, activeButton) {
            console.log('startChallenge called with duration:', duration);
            totalSeconds = duration;
            initialDuration = duration;
            
            // UI 업데이트
            challengeButtons.style.display = 'none';
            initialUI.style.display = 'none';
            h1.textContent = "숨, 쉼";
            timerContainer.style.display = 'block';
            resetButton.style.display = 'none';
            messageDisplay.textContent = '숨을 깊게 들이마시고, 천천히 내쉬세요.';

            // 사운드 재생
            console.log('natureSound element:', natureSound);
            const randomIndex = Math.floor(Math.random() * natureSounds.length);
            natureSound.src = natureSounds[randomIndex];
            console.log('natureSound.src set to:', natureSound.src);
            natureSound.currentTime = 0;
            natureSound.play()
                .then(() => {
                    console.log('Sound played successfully!');
                })
                .catch(error => {
                    console.error('Error playing sound in startChallenge:', error);
                    // Removed alert as audio context should be unlocked by now
                });

            updateTimerDisplay();

            timer = setInterval(() => {
                totalSeconds--;
                if (totalSeconds < 0) {
                    finishChallenge();
                } else {
                    updateTimerDisplay();
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            timerDisplay.textContent = `${minutes}:${seconds}`;

            const progressPercentage = ((initialDuration - totalSeconds) / initialDuration) * 100;
            progressBar.style.width = `${progressPercentage}%`;
        }

        function finishChallenge() {
            clearInterval(timer);
            messageDisplay.textContent = '명상을 완료했습니다. 편안한 하루 보내세요.';
            resetButton.style.display = 'block';
            natureSound.pause();
        }

        function resetChallenge() {
            clearInterval(timer);
            
            // UI 초기화
            h1.textContent = "명상 챌린지";
            challengeButtons.style.display = 'block';
            initialUI.style.display = 'block';
            timerContainer.style.display = 'none';
            resetButton.style.display = 'none';
            messageDisplay.textContent = '';
            progressBar.style.width = '0%';
            
            natureSound.pause();
            natureSound.currentTime = 0;
        }
    </script>
</body>
</html>